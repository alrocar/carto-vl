      <!DOCTYPE html>
<html>
<head>
  <title>Catastro MADRID | CARTO</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta charset="UTF-8">
  <script src="https://libs.cartocdn.com/carto-vl/v1.3.0/carto-vl.min.js"></script>
  <script src="https://api.tiles.mapbox.com/mapbox-gl-js/v1.0.0/mapbox-gl.js"></script>
  <link href="https://api.tiles.mapbox.com/mapbox-gl-js/v1.0.0/mapbox-gl.css" rel="stylesheet" />
  <link href="https://carto.com/developers/carto-vl/examples/maps/style.css" rel="stylesheet">
  <style>
    .CDB-Logo {
          -webkit-transform: translateX(-50%);
          -khtml-transform: translateX(-50%);
          -moz-transform: translateX(-50%);
          -ms-transform: translateX(-50%);
          -o-transform: translateX(-50%);
          transform: translateX(-50%);
          position: absolute;
          bottom: 0;
          left: 50%;
          width: auto;
          height: auto;
          z-index: 9999;
      }
    #attrs {
        position: fixed;
        left: 48px;
        bottom: 48px;
        color: white;
        font-size: 12px;
        font-family: sans-serif;
    }

    #attrs a {
        color: white;
        text-decoration-style: dotted;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <a class="CDB-Logo" href="https://carto.com" target="_blank">
    <svg width="68px" height="28px" viewBox="2 33 68 27" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
        <defs>
            <filter x="-50%" y="-50%" width="200%" height="200%" filterUnits="objectBoundingBox" id="cartoLogo-Blur">
                <feOffset dx="0" dy="1" in="SourceAlpha" result="shadowOffsetOuter1"></feOffset>
                <feGaussianBlur stdDeviation="0.5" in="shadowOffsetOuter1" result="shadowBlurOuter1"></feGaussianBlur>
                <feColorMatrix values="0 0 0 0 0   0 0 0 0 0   0 0 0 0 0  0 0 0 0.25 0" type="matrix" in="shadowBlurOuter1" result="shadowMatrixOuter1"></feColorMatrix>
                <feMerge>
                    <feMergeNode in="shadowMatrixOuter1"></feMergeNode>
                    <feMergeNode in="SourceGraphic"></feMergeNode>
                </feMerge>
            </filter>
        </defs>
        <g filter="url(#cartoLogo-Blur)" fill="none" fill-rule="evenodd" transform="translate(3, 33)">
            <circle cx="52.5" cy="12.5" r="12.5" id="halo" fill-opacity="0.3" fill="#ffffff"></circle>
            <path id="halo-path" d="M4.56199178,16.7836993 C6.33902821,16.7836993 7.36601679,15.9967983 8.12760383,14.9280222 L6.44288099,13.7065639 C5.95823469,14.3055483 5.46204919,14.7048712 4.61968777,14.7048712 C3.48884641,14.7048712 2.69264178,13.7417983 2.69264178,12.5085951 L2.69264178,12.4851056 C2.69264178,11.2871368 3.48884641,10.3005743 4.61968777,10.3005743 C5.39281401,10.3005743 5.9236171,10.6881524 6.385185,11.2636472 L8.06990784,9.93648577 C7.35447759,8.93817848 6.29287142,8.23349098 4.64276617,8.23349098 C2.19645628,8.23349098 0.396341463,10.1126576 0.396341463,12.5085951 L0.396341463,12.5320847 C0.396341463,14.9867462 2.25415227,16.7836993 4.56199178,16.7836993 L4.56199178,16.7836993 Z M11.9673421,16.6192722 L14.3097992,16.6192722 L14.8867591,15.1394285 L18.0138817,15.1394285 L18.5908415,16.6192722 L20.9909946,16.6192722 L17.5523137,8.33919411 L15.3944838,8.33919411 L11.9673421,16.6192722 Z M15.5444934,13.3659649 L16.45609,11.0404962 L17.3561474,13.3659649 L15.5444934,13.3659649 Z M25.3499968,16.6192722 L27.5886011,16.6192722 L27.5886011,14.1293764 L28.5809721,14.1293764 L30.207999,16.6192722 L32.78124,16.6192722 L30.854194,13.7535431 C31.8581042,13.3189858 32.5158385,12.4851056 32.5158385,11.2166681 L32.5158385,11.1931785 C32.5158385,10.3827879 32.2735154,9.7603139 31.8004082,9.27877744 C31.258066,8.72677223 30.4041653,8.39791807 29.1694712,8.39791807 L25.3499968,8.39791807 L25.3499968,16.6192722 Z M27.5886011,12.3441681 L27.5886011,10.3592983 L29.0656184,10.3592983 C29.8041271,10.3592983 30.2772342,10.6881524 30.2772342,11.3458608 L30.2772342,11.3693504 C30.2772342,11.9683347 29.8272055,12.3441681 29.0771576,12.3441681 L27.5886011,12.3441681 Z M39.1942194,16.6192722 L41.4328237,16.6192722 L41.4328237,10.3945326 L43.8560552,10.3945326 L43.8560552,8.39791807 L36.7825271,8.39791807 L36.7825271,10.3945326 L39.1942194,10.3945326 L39.1942194,16.6192722 Z M52.4193803,16.7708268 C54.7933139,16.7708268 56.7177673,14.8587096 56.7177673,12.4999935 C56.7177673,10.1412775 54.7933139,8.22916031 52.4193803,8.22916031 C50.0454467,8.22916031 48.1209933,10.1412775 48.1209933,12.4999935 C48.1209933,14.8587096 50.0454467,16.7708268 52.4193803,16.7708268 Z" fill="#ffffff"></path>
        </g>
    </svg>
  </a>
  <div id="attrs">
    Datos correspondientes a las capas EJES, ELEMLI y CONSTRU descargados de la Sede Electr√≥nica de Catastro
  </div>
  <div id="loader">
    <div class="CDB-LoaderIcon CDB-LoaderIcon--big">
      <svg class="CDB-LoaderIcon-spinner" viewBox="0 0 50 50">
        <circle class="CDB-LoaderIcon-path" cx="25" cy="25" r="20" fill="none"></circle>
      </svg>
    </div>
  </div>
  <script>
    const style = {
                    "version": 8,
                    "name": "voyager",
                    "metadata": {},
                    "sources": {
                        "carto": {
                            "type": "vector",
                            "url": "https://tiles.basemaps.cartocdn.com/vector/carto.streets/v1/tiles.json"
                        }
                    },
                    "sprite": "https://tiles.basemaps.cartocdn.com/gl/positron-gl-style/sprite",
                    "glyphs": "https://tiles.basemaps.cartocdn.com/fonts/{fontstack}/{range}.pbf",
                    "layers": [
                        {
                            "id": "background",
                            "type": "background",
                            "layout": {
                                "visibility": "visible"
                            },
                            "paint": {
                                "background-color": "#3B3B3B",
                                "background-opacity": 1
                            }
                        }
                    ],
                    "id": "voyager",
                    "owner": "Carto"
                };
    const map = new mapboxgl.Map({
      container: 'map',
      style: style,
      center: [8.45394, 28.312183],
      zoom: 11,
      scrollZoom: true,
      attributionControl: false
    });

    const nav = new mapboxgl.NavigationControl({
      showCompass: false
    });
    map.addControl(nav, 'top-left');

    // Define user
    carto.setDefaultAuth({
      username: 'aromeu',
      apiKey: 'default_public'
    });

    // Define layer
    const source = new carto.source.SQL(`WITH a AS
      (SELECT cartodb_id,
              area,
              fechaalta,
              ST_SetSRID(ST_Affine( ST_Rotate(the_geom, -pi() / 3), -- isometric
     cos(pi() / 6), -cos(pi() / 6), 0, sin(pi() / 6), sin(pi() / 6), 1, 0, 0, 0, 0, 0, 0 ), 4326) AS the_geom
       FROM aromeu.constru
       WHERE fechabaja = 99999999)
    SELECT a.cartodb_id,
           a.the_geom,
           area,
           to_date(FECHAALTA::text, 'YYYYMMDD') AS fechaalta,
           st_transform(a.the_geom, 3857) AS the_geom_webmercator
    FROM a`);
    const viz = new carto.Viz(`
      color: opacity(ramp(linear($fechaalta, time('2001-11-12T00:00:00Z'), time('2019-01-19T00:00:00Z')), PURP), 0.5)
      strokeWidth: 0
    `);
    const layer = new carto.Layer('layer', source, viz);

    const source_axis = new carto.source.SQL(`WITH a AS
      (SELECT cartodb_id,
              fechaalta,
              ST_SetSRID(ST_Affine( ST_Rotate(the_geom, -pi() / 3), -- isometric
     cos(pi() / 6), -cos(pi() / 6), 0, sin(pi() / 6), sin(pi() / 6), 1, 0, 0, 0, 0, 0, 0 ), 4326) AS the_geom
       FROM aromeu.ejes
       UNION ALL SELECT cartodb_id,
                        fechaalta,
                        ST_SetSRID(ST_Affine( ST_Rotate(the_geom, -pi() / 3), -- isometric
     cos(pi() / 6), -cos(pi() / 6), 0, sin(pi() / 6), sin(pi() / 6), 1, 0, 0, 0, 0, 0, 0 ), 4326) AS the_geom
       FROM aromeu.elemlin)
    SELECT a.cartodb_id,
           a.the_geom,
           st_distance(st_centroid(the_geom), st_setsrid(st_makepoint(9.45394, 30.312183), 4326)) AS lon,
           to_date(FECHAALTA::text, 'YYYYMMDD') AS fechaalta,
           st_transform(a.the_geom, 3857) AS the_geom_webmercator
    FROM a`);
    const viz_axis = new carto.Viz(`
      color: opacity(#D9D543, 0.3)
      filter: animation($lon, 2, fade(0., 1.8))^3 + 0.1
      strokeWidth: 1
    `);
    const layer_axis = new carto.Layer('layer_axis', source_axis, viz_axis);

    const source_logo = new carto.source.SQL(`SELECT cartodb_id,
           st_transform(ST_Scale(st_translate(the_geom, 1710, 5670), 0.005, 0.005), 3857) AS the_geom_webmercator,
           the_geom
    FROM aromeu.logo_madrid`);
    const viz_logo = new carto.Viz(`
      color: opacity(#D9A443, 1)
      filter: animation(linear($cartodb_id, 1 , 37), 10, fade(0.1, 31)) + 0.05
      strokeWidth: 1.5
    `);
    const layer_logo = new carto.Layer('layer_logo', source_logo, viz_logo);

    layer_axis.addTo(map, 'background');
    layer.addTo(map, 'layer_axis');
    layer_logo.addTo(map, 'background');

    layer.on('loaded', hideLoader);

    function hideLoader() {
      document.getElementById('loader').style.opacity = '0';
    }
  </script>
</body>
</html>

