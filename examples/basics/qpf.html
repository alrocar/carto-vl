<!DOCTYPE html>
<html>
<head>
  <title>US Precipitation Forecasts | CARTO</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta charset="UTF-8">
  <!-- Include CARTO VL JS -->
  <script src="../../dist/carto-vl.min.js"></script>
  <!-- Include Mapbox GL JS -->
  <script src="https://libs.cartocdn.com/mapbox-gl/v0.45.0-carto1/mapbox-gl.js"></script>
  <!-- Include Mapbox GL CSS -->
  <link href="https://libs.cartocdn.com/mapbox-gl/v0.45.0-carto1/mapbox-gl.css" rel="stylesheet" />
  <link href="../style.css" rel="stylesheet" />
  <style>
    body {
      margin: 0;
      padding: 0;
    }
    #map {
      position: absolute;
      height: 100%;
      width: 100%;
    }
    .CDB-Logo {
        -webkit-transform: translateX(-50%);
        -khtml-transform: translateX(-50%);
        -moz-transform: translateX(-50%);
        -ms-transform: translateX(-50%);
        -o-transform: translateX(-50%);
        transform: translateX(-50%);
        position: absolute;
        bottom: 0;
        left: 50%;
        width: auto;
        height: auto;
        z-index: 9999;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <a class="CDB-Logo" href="https://carto.com" target="_blank">
    <svg width="68px" height="28px" viewBox="2 33 68 27" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
        <defs>
            <filter x="-50%" y="-50%" width="200%" height="200%" filterUnits="objectBoundingBox" id="cartoLogo-Blur">
                <feOffset dx="0" dy="1" in="SourceAlpha" result="shadowOffsetOuter1"></feOffset>
                <feGaussianBlur stdDeviation="0.5" in="shadowOffsetOuter1" result="shadowBlurOuter1"></feGaussianBlur>
                <feColorMatrix values="0 0 0 0 0   0 0 0 0 0   0 0 0 0 0  0 0 0 0.25 0" type="matrix" in="shadowBlurOuter1" result="shadowMatrixOuter1"></feColorMatrix>
                <feMerge>
                    <feMergeNode in="shadowMatrixOuter1"></feMergeNode>
                    <feMergeNode in="SourceGraphic"></feMergeNode>
                </feMerge>
            </filter>
        </defs>
        <g filter="url(#cartoLogo-Blur)" fill="none" fill-rule="evenodd" transform="translate(3, 33)">
            <circle cx="52.5" cy="12.5" r="12.5" id="halo" fill-opacity="0.3" fill="#ffffff"></circle>
            <path id="halo-path" d="M4.56199178,16.7836993 C6.33902821,16.7836993 7.36601679,15.9967983 8.12760383,14.9280222 L6.44288099,13.7065639 C5.95823469,14.3055483 5.46204919,14.7048712 4.61968777,14.7048712 C3.48884641,14.7048712 2.69264178,13.7417983 2.69264178,12.5085951 L2.69264178,12.4851056 C2.69264178,11.2871368 3.48884641,10.3005743 4.61968777,10.3005743 C5.39281401,10.3005743 5.9236171,10.6881524 6.385185,11.2636472 L8.06990784,9.93648577 C7.35447759,8.93817848 6.29287142,8.23349098 4.64276617,8.23349098 C2.19645628,8.23349098 0.396341463,10.1126576 0.396341463,12.5085951 L0.396341463,12.5320847 C0.396341463,14.9867462 2.25415227,16.7836993 4.56199178,16.7836993 L4.56199178,16.7836993 Z M11.9673421,16.6192722 L14.3097992,16.6192722 L14.8867591,15.1394285 L18.0138817,15.1394285 L18.5908415,16.6192722 L20.9909946,16.6192722 L17.5523137,8.33919411 L15.3944838,8.33919411 L11.9673421,16.6192722 Z M15.5444934,13.3659649 L16.45609,11.0404962 L17.3561474,13.3659649 L15.5444934,13.3659649 Z M25.3499968,16.6192722 L27.5886011,16.6192722 L27.5886011,14.1293764 L28.5809721,14.1293764 L30.207999,16.6192722 L32.78124,16.6192722 L30.854194,13.7535431 C31.8581042,13.3189858 32.5158385,12.4851056 32.5158385,11.2166681 L32.5158385,11.1931785 C32.5158385,10.3827879 32.2735154,9.7603139 31.8004082,9.27877744 C31.258066,8.72677223 30.4041653,8.39791807 29.1694712,8.39791807 L25.3499968,8.39791807 L25.3499968,16.6192722 Z M27.5886011,12.3441681 L27.5886011,10.3592983 L29.0656184,10.3592983 C29.8041271,10.3592983 30.2772342,10.6881524 30.2772342,11.3458608 L30.2772342,11.3693504 C30.2772342,11.9683347 29.8272055,12.3441681 29.0771576,12.3441681 L27.5886011,12.3441681 Z M39.1942194,16.6192722 L41.4328237,16.6192722 L41.4328237,10.3945326 L43.8560552,10.3945326 L43.8560552,8.39791807 L36.7825271,8.39791807 L36.7825271,10.3945326 L39.1942194,10.3945326 L39.1942194,16.6192722 Z M52.4193803,16.7708268 C54.7933139,16.7708268 56.7177673,14.8587096 56.7177673,12.4999935 C56.7177673,10.1412775 54.7933139,8.22916031 52.4193803,8.22916031 C50.0454467,8.22916031 48.1209933,10.1412775 48.1209933,12.4999935 C48.1209933,14.8587096 50.0454467,16.7708268 52.4193803,16.7708268 Z" fill="#ffffff"></path>
        </g>
    </svg>
  </a>
  <aside class="toolbox">
    <div class="box">
      <header>
        <h1>US Precipitation Forecasts</h1>
      </header>
      <section>
        <p class="description open-sans">A map that visualizes US Quantitative Precipitation Forecasts for today. Data taken from <a style={{color: 'white'}} href="http://ftp.hpc.ncep.noaa.gov/shapefiles/qpf/day1/" target="_blank">NOAA</a> and updated hourly</p>
        <strong><h1 class="description open-sans" id="date"></h1></strong>
      </section>
      <footer class="js-footer"></footer>
    </div>
  </aside>
  <div id="loader">
    <div class="CDB-LoaderIcon CDB-LoaderIcon--big">
      <svg class="CDB-LoaderIcon-spinner" viewBox="0 0 50 50">
        <circle class="CDB-LoaderIcon-path" cx="25" cy="25" r="20" fill="none"></circle>
      </svg>
    </div>
  </div>
  <script>
    var username = "aromeu",
    sql = "SELECT cartodb_id, postal, name_1, the_geom, st_transform(the_geom, 2163) as the_geom_webmercator FROM state_points",
    url = `https://${username}.carto.com/api/v1/map`,
    mapconfig = {
      layers: [
        {
          type: "cartodb",
          options: { sql: sql }
        }
      ]
    },
    simple_style = {
        version: 8,
        "sprite": "https://tiles.basemaps.cartocdn.com/gl/positron-gl-style/sprite",
        "glyphs": "https://tiles.basemaps.cartocdn.com/fonts/{fontstack}/{range}.pbf",
        sources: {
          tilejson: {
            type: "vector",
            tiles: null // we don't know this data yet :-)
          }
        },
        layers: [
          {
            "id": "background",
            "type": "background",
            "layout": {
                "visibility": "visible"
            },
            "paint": {
                "background-color": "#3B3B3B",
                "background-opacity": 1
            }
          },
          {
            id: "layer2",
            type: "symbol",
            source: "tilejson",
            "source-layer": "layer0",
            "maxzoom": 4,
            "layout": {
                "text-field": "{postal}",
                "text-font": [
                    "Montserrat Medium",
                    "Open Sans Bold",
                    "Noto Sans Regular",
                    "HanWangHeiLight Regular",
                    "NanumBarunGothic Regular"
                ],
                "text-size": 12,
                "icon-image": "circle-11",
                "icon-offset": [
                    16,
                    5
                ],
                "text-anchor": "right",
                "icon-size": 0,
                "text-max-width": 8,
                "text-keep-upright": true,
                "text-offset": [
                    0.2,
                    0.2
                ],
                "text-transform": "uppercase"
            },
            "paint": {
                "text-color": "#666",
                "icon-color": "#666",
                "icon-translate-anchor": "map",
                "text-halo-color": "#222",
                "text-halo-width": 1
            }
          },
          {
            id: "layer3",
            type: "symbol",
            source: "tilejson",
            "source-layer": "layer0",
            "minzoom": 4,
            "layout": {
                "text-field": "{name_1}",
                "text-font": [
                    "Montserrat Medium",
                    "Open Sans Bold",
                    "Noto Sans Regular",
                    "HanWangHeiLight Regular",
                    "NanumBarunGothic Regular"
                ],
                "text-size": 12,
                "icon-image": "circle-11",
                "icon-offset": [
                    16,
                    5
                ],
                "text-anchor": "right",
                "icon-size": 0,
                "text-max-width": 8,
                "text-keep-upright": true,
                "text-offset": [
                    0.2,
                    0.2
                ],
                "text-transform": "uppercase"
            },
            "paint": {
                "text-color": "#666",
                "icon-color": "#666",
                "icon-translate-anchor": "map",
                "text-halo-color": "#222",
                "text-halo-width": 1
            }
          }
        ]
      };


    fetch(url, {
      method: "POST",
      body: JSON.stringify(mapconfig),
      headers: new Headers({
        "Content-Type": "application/json"
      })
    })
    .then(res => res.json())
    .catch(error => console.error("Error:", error))
    .then(function(response) {
      simple_style.sources.tilejson.tiles = response.metadata.tilejson.vector.tiles;
      loadMap(simple_style);
    });

    function loadMap(style) {
      const map = new mapboxgl.Map({
        container: 'map',
        'style': style,
        center: [0, 0],
        zoom: 1,
        dragRotate: false
      });

      const duration = 40;
      const fadeOut = 12;

      carto.setDefaultAuth({
        user: 'aromeu',
        apiKey: 'default_public'
      });

      const worldSource = new carto.source.SQL(`
        SELECT cartodb_id,
               the_geom,
               st_transform(the_geom, 2163) AS the_geom_webmercator
        FROM world_borders_hd_1
      `);

      const waterSource = new carto.source.SQL(`
        SELECT cartodb_id,
               the_geom,
               st_transform(the_geom, 2163) AS the_geom_webmercator
        FROM detailed_water
      `);

      const stateSource = new carto.source.SQL(`
        SELECT cartodb_id,
               the_geom,
               source_table,
               st_transform(the_geom, 2163) AS the_geom_webmercator
        FROM state_county_merge where source_table = 'states_50m'
      `);

      const countiesSource = new carto.source.SQL(`
        SELECT cartodb_id,
               the_geom,
               source_table,
               st_transform(the_geom, 2163) AS the_geom_webmercator
        FROM state_county_merge where source_table = 'county_20m'
      `);

      const qpfPolySource = new carto.source.SQL(`
       WITH rain_pred as (
        SELECT cartodb_id, the_geom, the_geom_webmercator, id::float, qpf::float, product, valid_time, units, issue_time, start_time, end_time FROM table_91e0606
        UNION ALL
        SELECT cartodb_id, the_geom, the_geom_webmercator, id::float, qpf::float, product, valid_time, units, issue_time, start_time, end_time FROM table_92e0612
        UNION ALL
        SELECT cartodb_id, the_geom, the_geom_webmercator, id::float, qpf::float, product, valid_time, units, issue_time, start_time, end_time FROM table_93e0612
        UNION ALL
        SELECT cartodb_id, the_geom, the_geom_webmercator, id::float, qpf::float, product, valid_time, units, issue_time, start_time, end_time FROM table_9ee0612
        UNION ALL
        SELECT cartodb_id, the_geom, the_geom_webmercator, id::float, qpf::float, product, valid_time, units, issue_time, start_time, end_time FROM table_9fe0612)
       SELECT cartodb_id,
               the_geom,
               qpf,
               EXTRACT(EPOCH FROM to_timestamp(start_time, 'YYYY-MM-DD HH24:MI:SS')) as start_time,
               st_transform(the_geom, 2163) AS the_geom_webmercator
        FROM rain_pred ORDER BY start_time asc
      `);

      const qpfSource = new carto.source.SQL(`
        WITH rain_pred as (
          SELECT cartodb_id, the_geom, the_geom_webmercator, id::float, qpf::float, product, valid_time, units, issue_time, start_time, end_time FROM table_91e0606
          UNION ALL
          SELECT cartodb_id, the_geom, the_geom_webmercator, id::float, qpf::float, product, valid_time, units, issue_time, start_time, end_time FROM table_92e0612
          UNION ALL
          SELECT cartodb_id, the_geom, the_geom_webmercator, id::float, qpf::float, product, valid_time, units, issue_time, start_time, end_time FROM table_93e0612
          UNION ALL
          SELECT cartodb_id, the_geom, the_geom_webmercator, id::float, qpf::float, product, valid_time, units, issue_time, start_time, end_time FROM table_9ee0612
          UNION ALL
          SELECT cartodb_id, the_geom, the_geom_webmercator, id::float, qpf::float, product, valid_time, units, issue_time, start_time, end_time FROM table_9fe0612),
        vertices AS
          (SELECT cartodb_id,
                  qpf,
                  start_time,
                  (ST_DumpPoints(the_geom)).path[1] AS v_id,
                                                (ST_DumpPoints(the_geom)).geom AS vertex
           FROM rain_pred ),
             rain AS
          ( SELECT cartodb_id,
                   qpf,
                   start_time,
                   v_id,
                   ST_SetSRID(
                    ST_Translate(
                      ST_Rotate(
                        ST_MakeLine(
                          ST_MakePoint(-least(qpf, 0.5),0.0),
                          ST_MakePoint(least(qpf, 0.5),0.0)
                        ), radians(60)
                      ), ST_X(vertex), ST_Y(Vertex)
                    ), ST_SRID(vertex)
                  ) AS the_geom
           FROM vertices)
        SELECT cartodb_id,
               qpf,
               EXTRACT(EPOCH FROM to_timestamp(start_time, 'YYYY-MM-DD HH24:MI:SS')) as start_time,
               v_id,
               the_geom,
               st_transform(the_geom, 2163) AS the_geom_webmercator
        FROM rain ORDER BY start_time asc
      `);

      const qpfPointsSource = new carto.source.SQL(`
        WITH rain_pred as (
          SELECT cartodb_id, the_geom, the_geom_webmercator, id::float, qpf::float, product, valid_time, units, issue_time, start_time, end_time FROM table_91e0606
          UNION ALL
          SELECT cartodb_id, the_geom, the_geom_webmercator, id::float, qpf::float, product, valid_time, units, issue_time, start_time, end_time FROM table_92e0612
          UNION ALL
          SELECT cartodb_id, the_geom, the_geom_webmercator, id::float, qpf::float, product, valid_time, units, issue_time, start_time, end_time FROM table_93e0612
          UNION ALL
          SELECT cartodb_id, the_geom, the_geom_webmercator, id::float, qpf::float, product, valid_time, units, issue_time, start_time, end_time FROM table_9ee0612
          UNION ALL
          SELECT cartodb_id, the_geom, the_geom_webmercator, id::float, qpf::float, product, valid_time, units, issue_time, start_time, end_time FROM table_9fe0612),
        vertices AS
          (SELECT cartodb_id,
                  qpf,
                  start_time,
                  (ST_DumpPoints(the_geom)).path[1] AS v_id,
                                                (ST_DumpPoints(the_geom)).geom AS vertex
           FROM rain_pred ),
             rain AS
          ( SELECT cartodb_id,
                   qpf,
                   start_time,
                   v_id,
                   ST_SetSRID(
                    ST_Translate(
                      ST_Rotate(
                        ST_MakeLine(
                          ST_MakePoint(-least(qpf, 0.5),0.0),
                          ST_MakePoint(least(qpf, 0.5),0.0)
                        ), radians(60)
                      ), ST_X(vertex), ST_Y(Vertex)
                    ), ST_SRID(vertex)
                  ) AS the_geom
           FROM vertices)
        SELECT cartodb_id,
               qpf,
               to_timestamp(start_time, 'YYYY-MM-DD HH24:MI:SS') as start_time,
               v_id,
               ST_StartPoint(the_geom) as the_geom,
               st_transform(ST_StartPoint(the_geom), 2163) AS the_geom_webmercator
        FROM rain ORDER BY start_time asc
      `);
      // color: opacity(ramp(linear(log(clusterAvg($grupo)), 0, 4), Geyser), clusterSum($grupo)*zoom()/100000*1.8*4)
   //    BURG, BURGYL, REDOR, ORYEL, PEACH, PINKYL, MINT, BLUGRN, DARKMINT, EMRLD, AG_GRNYL, BLUYL, TEAL, TEALGRN,
   // *  PURP, PURPOR, SUNSET, MAGENTA, SUNSETDARK, AG_SUNSET, BRWNYL, ARMYROSE, FALL, GEYSER, TEMPS, TEALROSE, TROPIC,
   // *  EARTH, ANTIQUE, BOLD, PASTEL, PRISM, SAFE, VIVID, CB_YLGN, CB_YLGNBU, CB_GNBU, CB_BUGN, CB_PUBUGN, CB_PUBU,
   // *  CB_BUPU, CB_RDPU, CB_PURD, CB_ORRD, CB_YLORRD, CB_YLORBR, CB_PURPLES, CB_BLUES, CB_GREENS, CB_ORANGES, CB_REDS,
   // *  CB_GREYS, CB_PUOR, CB_BRBG, CB_PRGN, CB_PIYG, CB_RDBU, CB_RDGY, CB_RDYLBU, CB_SPECTRAL, CB_RDYLGN, CB_ACCENT,
   // *  CB_DARK2, CB_PAIRED, CB_PASTEL1, CB_PASTEL2, CB_SET1, CB_SET2, CB_SET3
      // const qpfViz = new carto.Viz(`
      //   color: ramp($qpf, mint)
      //   width: $qpf * zoom() / 5
      //   filter: and($qpf > 1, torque($start_time, 10, fade(1, 3)) + 0.5)
      // `);

      // const qpfViz2 = new carto.Viz(`
      //   color: ramp($qpf, EMRLD)
      //   width: $qpf * zoom() / 10
      //   filter: and($qpf <= 1, torque($start_time, 10, fade(1, 3)) + 0.7)
      // `);

      const qpfViz = new carto.Viz(`
        color: ramp($qpf, mint)
        width: $qpf * zoom() / 5
        filter: and($qpf >= 0, torque($start_time, ${duration}, fade(1, ${fadeOut})))
      `);

      const qpfPolyViz = new carto.Viz(`
        color: opacity(ramp($qpf, teal), 0.14)
        strokeWidth: 0
        filter: torque($start_time, ${duration}, fade(1, ${fadeOut}))
      `);

      const s = carto.expressions;
      const torque = s.torque(s.prop('start_time'), duration, s.fade(1, fadeOut));
      setInterval(function() {
        document.getElementById('date').textContent = torque.getSimTime()
      }, 1000);
      const viz = new carto.Viz({
        color: s.opacity(s.ramp(s.prop('qpf'), s.palettes.TEAL), 1),
        width: s.div(s.mul(s.prop('qpf'), s.zoom()), 5),
        strokeWidth: 0,
        filter: torque
      });

      const qpfPointsViz = viz;

      // const qpfPointsViz = new carto.Viz(`
      //   color: opacity(ramp($qpf, teal), 1)
      //   width: $qpf * zoom() / 5
      //   strokeWidth: 0
      //   filter: and($qpf > 0.2, torque($start_time, 10, fade(1, 3)))
      // `);

      const worldViz = new carto.Viz(`
        color: opacity(#303030, 0.4)
        strokeColor: opacity(#ffffff, 0)
      `);

      const stateViz = new carto.Viz(`
         strokeWidth: 1;
         strokeColor: opacity(#4c4c4c, 0.8);
         color: opacity(#2b2b2b, 0.9)
         filter: and(zoom() < 6, $source_table == "states_50m")
      `);

      const stateZoomViz = new carto.Viz(`
         strokeWidth: 2;
         strokeColor: opacity(#4c4c4c, 1);
         color: opacity(#2b2b2b, 0.9)
         filter: and(zoom() >= 6, $source_table == "states_50m")
      `);

      const countiesViz = new carto.Viz(`
         strokeWidth: 1;
         strokeColor: opacity(#383838, 0.6);
         color: opacity(#2b2b2b, 0.9)
         filter: and(zoom() >= 6, $source_table == "county_20m")
      `);

      const waterViz = new carto.Viz(`
        color: opacity(#3b3b3b, 1)
        strokeColor: opacity(#ffffff, 0)
      `);

      const worldLayer = new carto.Layer('world', worldSource, worldViz);
      const countiesLayer = new carto.Layer('counties', countiesSource, countiesViz);
      const stateZoomLayer = new carto.Layer('stateZoom', stateSource, stateZoomViz);
      const stateLayer = new carto.Layer('state', stateSource, stateViz);
      const waterLayer = new carto.Layer('water', waterSource, waterViz);
      const qpfPolyLayer = new carto.Layer('qpfPoly', qpfPolySource, qpfPolyViz);
      const qpfPointsLayer = new carto.Layer('qpfPoints', qpfPointsSource, qpfPointsViz);
      const qpfLayer = new carto.Layer('qpf', qpfSource, qpfViz);

      qpfLayer.on('loaded', hideLoader);

      worldLayer.addTo(map, 'background');
      waterLayer.addTo(map, 'world');
      countiesLayer.addTo(map, 'world');
      stateZoomLayer.addTo(map, 'counties');
      stateLayer.addTo(map, 'counties');
      qpfLayer.addTo(map, 'world');
      qpfPointsLayer.addTo(map, 'world');
      qpfPolyLayer.addTo(map, 'world');

      function hideLoader() {
        map.flyTo({
          center: [0, 0],
          zoom: 4,
          speed: 1,
          curve: 1,
          easing(t) {
            return t;
          }
        });
        document.getElementById('loader').style.opacity = '0';
      }

    }
  </script>
</body>
</html>

